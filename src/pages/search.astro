---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';

const posts = await getCollection('blog');
const searchList = posts.map(post => ({
    title: post.data.title,
    description: post.data.description,
    summary: post.data.summary,
    pubDate: post.data.pubDate,
    slug: post.id
}));
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Search | ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
	</head>
	<body class="bg-zinc-50 text-zinc-900 font-sans antialiased min-h-screen flex flex-col">
		<Header />
		<main class="w-full max-w-3xl mx-auto px-4 py-12 md:py-20 flex-grow">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-zinc-900 mb-8 font-display">Search</h1>

            <div id="search-container" data-search-list={JSON.stringify(searchList)} data-base-url={import.meta.env.BASE_URL} class="w-full">
                <div class="relative mb-12">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-zinc-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input type="text" id="search" placeholder="Search posts..." class="block w-full pl-10 pr-3 py-4 border border-zinc-300 rounded-xl leading-5 bg-white placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 sm:text-lg transition-shadow shadow-sm" />
                </div>

                <ul id="results" class="space-y-6"></ul>
                <p id="no-results" class="hidden text-center text-zinc-500 mt-8">No results found.</p>
            </div>
		</main>
		<Footer />

        <script>
            import Fuse from 'fuse.js';

            const container = document.getElementById('search-container');
            const noResults = document.getElementById('no-results');

            if (container) {
                const searchList = JSON.parse(container.dataset.searchList);
                const baseUrl = container.dataset.baseUrl;
                const options = {
                    keys: ['title', 'description', 'summary'],
                    includeScore: true,
                    threshold: 0.4
                };

                const fuse = new Fuse(searchList, options);
                const searchInput = document.getElementById('search');
                const resultsUl = document.getElementById('results');

                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value;
                    if (!query) {
                        resultsUl.innerHTML = '';
                        noResults.classList.add('hidden');
                        return;
                    }

                    const results = fuse.search(query);

                    if (results.length === 0) {
                        resultsUl.innerHTML = '';
                        noResults.classList.remove('hidden');
                    } else {
                        noResults.classList.add('hidden');
                        resultsUl.innerHTML = results.map(result => `
                            <li class="group border-b border-zinc-200 pb-6 last:border-0">
                                <a href="${baseUrl}posts/${result.item.slug}/" class="block group-hover:bg-zinc-50 -mx-4 px-4 py-4 rounded-xl transition-colors">
                                    <h3 class="text-xl font-bold text-zinc-900 group-hover:text-blue-600 mb-2 font-display">${result.item.title}</h3>
                                    <p class="text-zinc-600 line-clamp-2 text-sm leading-relaxed">${result.item.description || result.item.summary || ''}</p>
                                </a>
                            </li>
                        `).join('');
                    }
                });
            }
        </script>
	</body>
</html>
