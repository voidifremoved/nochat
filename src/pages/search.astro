---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';

const posts = await getCollection('blog');
const searchList = posts.map(post => ({
    title: post.data.title,
    description: post.data.description,
    pubDate: post.data.pubDate,
    slug: post.id
}));
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Search | ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main>
            <h1>Search</h1>
            <div id="search-container" data-search-list={JSON.stringify(searchList)} data-base-url={import.meta.env.BASE_URL}>
                <input type="text" id="search" placeholder="Search..." class="search-input" />
                <ul id="results"></ul>
            </div>
		</main>
		<Footer />

        <script>
            import Fuse from 'fuse.js';

            const container = document.getElementById('search-container');
            if (container) {
                const searchList = JSON.parse(container.dataset.searchList);
                const baseUrl = container.dataset.baseUrl;
                const options = {
                    keys: ['title', 'description'],
                    includeScore: true,
                    threshold: 0.4
                };

                const fuse = new Fuse(searchList, options);
                const searchInput = document.getElementById('search');
                const resultsUl = document.getElementById('results');

                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value;
                    if (!query) {
                        resultsUl.innerHTML = '';
                        return;
                    }

                    const results = fuse.search(query);

                    resultsUl.innerHTML = results.map(result => `
                        <li class="result-item">
                            <a href="${baseUrl}posts/${result.item.slug}/">
                                <h3>${result.item.title}</h3>
                            </a>
                            <p>${result.item.description || ''}</p>
                        </li>
                    `).join('');
                });
            }
        </script>

        <style>
            .search-input {
                width: 100%;
                padding: 0.5rem;
                font-size: 1.2rem;
                margin-bottom: 2rem;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
            .result-item {
                margin-bottom: 1.5rem;
                list-style: none;
            }
            ul {
                padding: 0;
            }
            h3 {
                margin: 0;
            }
        </style>
	</body>
</html>
